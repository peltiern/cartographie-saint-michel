<!DOCTYPE html>
<html>
<head>
    <title>Cartographie de Saint-Michel (16470 - France)</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.ico"/>
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            crossorigin=""></script>
    <!--    <script src="https://cdn.jsdelivr.net/npm/osmtogeojson@3.0.0/osmtogeojson.min.js"></script>-->

    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 220px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            font-family: sans-serif;
            font-size: 13px;
            z-index: 1000;
        }

        .control-header {
            padding: 8px 12px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
        }

        .control-content {
            padding: 8px 12px;
            display: block;
        }

        .layer-group {
            margin-bottom: 10px;
        }

        .layer-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .layer-group input[type="range"] {
            width: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Panneau de contr√¥le -->
<div class="control-panel">
    <div class="control-header" onclick="togglePanel()">üó∫Ô∏è Couches</div>
    <div class="control-content" id="layerControl">
        <!-- Contenu g√©n√©r√© dynamiquement -->
    </div>
</div>

<script>
    function togglePanel() {
        const content = document.getElementById("layerControl");
        content.style.display = content.style.display === "none" ? "block" : "none";
    }

    const map = L.map('map', {attributionControl: false}).setView([45.641, 0.121589], 16);
    L.control.attribution({prefix: false}).addTo(map);

    const layers = [
        {
            name: "OpenStreetMap",
            layer: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '¬© OpenStreetMap'
            }).addTo(map),
            defaultOpacity: 1,
            controlOpacity: true
        },
        {
            name: "IGN Orthophotos",
            layer: L.tileLayer(
                "https://data.geopf.fr/wmts?" +
                "&REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0" +
                "&STYLE=normal&TILEMATRIXSET=PM&FORMAT=image/jpeg" +
                "&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&TILEMATRIX={z}" +
                "&TILEROW={y}&TILECOL={x}",
                {
                    minZoom: 0,
                    maxZoom: 18,
                    attribution: "IGN-F/Geoportail",
                    tileSize: 256
                }
            ).addTo(map),
            defaultOpacity: 1,
            controlOpacity: true
        },
        {
            name: "Carte 1922",
            layer: L.tileLayer('https://github.com/peltiern/cartographie-saint-michel/raw/main/1922/{z}/{x}/{y}.png', {
                minZoom: 12,
                maxZoom: 18,
                tms: false,
                attribution: 'Cr√©√© avec QGIS | Nicolas PELTIER | Blason par <a href="//commons.wikimedia.org/wiki/User:Celbusro" title="User:Celbusro">Celbusro</a> ‚Äî <span class="int-own-work" lang="fr">Travail personnel</span>, <a href="https://creativecommons.org/licenses/by-sa/4.0" title="Creative Commons Attribution-Share Alike 4.0">CC BY-SA 4.0</a>, <a href="https://commons.wikimedia.org/w/index.php?curid=35491899">Lien</a>'
            }).addTo(map),
            defaultOpacity: 1,
            controlOpacity: true
        }
    ];

    // D√©finir les marqueurs pr√©d√©finis
    var eglise = L.marker([45.6423319, 0.1056722]).bindPopup('Eglise');
    var ecolePrimaire = L.marker([45.6403061, 0.1082331]).bindPopup('Ecole primaire');
    var centreCommercial = L.marker([45.6373693, 0.1117523]).bindPopup('Centre commercial');
    var stade = L.marker([45.6347353, 0.1151324]).bindPopup('Stade');
    var college = L.marker([45.6376276, 0.1160621]).bindPopup('Coll√®ge');

    // Cr√©er un groupe de marqueurs
    var predefinedMarkers = L.layerGroup([eglise, ecolePrimaire, centreCommercial, stade, college]);

    // Ajouter la couche √† la carte (elle sera ajout√©e par d√©faut)
    predefinedMarkers.addTo(map);

    // Ajout d'une nouvelle couche √† la liste des couches
    layers.push({
        name: "Points remarquables",
        layer: predefinedMarkers,
        defaultOpacity: 1,
        controlOpacity: false
    });

    const controlContainer = document.getElementById("layerControl");

    layers.forEach(({name, layer, defaultOpacity, controlOpacity}, index) => {
        const group = document.createElement("div");
        group.className = "layer-group";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true;
        checkbox.id = `layer-${index}`;

        const slider = document.createElement("input");

        const label = document.createElement("label");
        label.htmlFor = checkbox.id;
        label.innerHTML = `<span>${name}</span>`;
        label.prepend(checkbox);
        group.appendChild(label);

        checkbox.onchange = () => {
            if (checkbox.checked) {
                if (controlOpacity) {
                    layer.setOpacity(parseFloat(slider.value));
                } else {
                    layer.addTo(map); // Ajouter les marqueurs ou autres couches √† la carte
                }
            } else {
                if (controlOpacity) {
                    layer.setOpacity(0); // Retirer l'opacit√©
                } else {
                    map.removeLayer(layer); // Retirer les marqueurs ou autres couches de la carte
                }
            }
        };

        if (controlOpacity) {
            slider.type = "range";
            slider.min = 0;
            slider.max = 1;
            slider.step = 0.01;
            slider.value = defaultOpacity;

            slider.oninput = () => {
                if (checkbox.checked) {
                    layer.setOpacity(parseFloat(slider.value));
                }
            };

            group.appendChild(slider);
        }

        // Set initial opacity si c'est une couche de type GeoJSON
        if (controlOpacity) {
            layer.setOpacity(defaultOpacity);
        }

        controlContainer.appendChild(group);
    });

    //   // Charger les rues depuis Overpass API via osmtogeojson
    //   const overpassUrl = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(`
    //   [out:json][timeout:25];
    //   (
    //     way["highway"](45.63, 0.10, 45.65, 0.14);
    //   );
    //   out body;
    //   >;
    //   out skel qt;
    // `);
    //
    //   fetch(overpassUrl)
    //       .then(r => r.json())
    //       .then(osmData => osmtogeojson(osmData))
    //       .then(geojson => {
    //           const rueLayer = L.geoJSON(geojson, {
    //               style: { color: "#ff6600", weight: 1.5 },
    //               onEachFeature: (feature, layer) => {
    //                   if (feature.properties.name) {
    //                       layer.bindPopup(feature.properties.name);
    //                   }
    //               }
    //           }).addTo(map);
    //           layers.push({ name: "Rues OSM", layer: rueLayer });
    //           addLayerControl({ name: "Rues OSM", layer: rueLayer });
    //       });
    //
    //   // Charger osmtogeojson
    //   const script = document.createElement('script');
    //   script.src = "https://rawcdn.githack.com/tyrasd/osmtogeojson/gh-pages/osmtogeojson.js";
    //   document.head.appendChild(script);
</script>
</body>
</html>
